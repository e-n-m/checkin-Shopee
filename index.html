<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check-in HUB (Motorista)</title>

  <!-- favicon no repositório -->
  <link rel="icon" href="favicon.ico" />

  <style>
    :root{
      --terracota:#E55A36;
      --terracota-dk:#cf4f30;
      --bg:#f5f6f8;
      --card:#ffffff;
      --txt:#1b1d22;
      --muted:#6b7280;
      --ok:#0a7f2f;
      --warn:#8a4b16;
      --danger:#a32121;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{
      background:#0B1324;color:#fff;padding:16px;
      display:flex;align-items:center;gap:12px
    }
    header img{height:22px;display:block}
    header .sub{color:#a5b0c9;font-size:12px}
    main{max-width:1000px;margin:24px auto;padding:0 16px}
    .card{
      background:var(--card);border-radius:16px;padding:24px;box-shadow:0 10px 24px rgba(0,0,0,.08)
    }
    h1{font-size:22px;margin:0 0 16px}
    input[type=text]{
      width:100%;font-size:18px;padding:14px 16px;border:1px solid #e3e5ea;border-radius:12px;outline:none
    }
    .row{display:flex;gap:12px;align-items:center}
    .btn{
      background:var(--terracota);color:#fff;border:0;border-radius:12px;
      padding:14px 18px;font-size:18px;cursor:pointer
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn.secondary{
      background:#fbe5dd;color:#5b2d1f;border:1px solid #f3c7b9
    }
    .btn:hover{background:var(--terracota-dk)}
    .btn.secondary:hover{filter:brightness(.98)}
    .hint{margin-top:12px;background:#fff4e8;border:1px solid #ffd7b0;color:var(--warn);padding:12px;border-radius:10px}
    .ok{color:var(--ok);margin-top:12px}
    .err{color:var(--danger);margin-top:12px}
    .badge{display:inline-block;background:#0b1324;color:#fff;border-radius:999px;padding:2px 10px;font-size:12px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  </style>
</head>
<body>
  <header>
    <img src="shopito.svg" alt="Shopito" />
    <div>
      <div><strong>Check-in HUB</strong> <span class="badge">Motorista</span></div>
      <div class="sub">Operação Shopee • Check-in com geolocalização</div>
    </div>
  </header>

  <main>
    <section class="card">
      <h1>Check-in</h1>

      <div class="row" style="margin-bottom:12px">
        <input id="driverId" type="text" inputmode="numeric" placeholder="Digite seu Driver ID" />
        <button id="btnCheckin" class="btn">Registrar check-in</button>
      </div>

      <div class="row">
        <button id="btnGeo" class="btn secondary">Habilitar localização</button>
        <div id="permInfo" class="sub"></div>
      </div>

      <div class="hint">Para registrar o check-in é necessário permitir a localização.</div>

      <div id="msg" class="ok" style="display:none"></div>
      <div id="err" class="err" style="display:none"></div>

      <div class="sub" style="margin-top:16px">
        <span class="badge" id="permBadge">Permissão: prompt</span>
        <span class="badge">Raio: <span id="raioBadge">2</span> km</span>
      </div>
    </section>
  </main>

  <script>
    // ============= CONFIGURAÇÃO DA BASE / GEOFENCE =============
    // Coordenadas do HUB (pode alterar no admin também, se usa localStorage)
    let LAT_BASE  = parseFloat(localStorage.getItem('cfg_lat') ?? '-22.798782412241856');
    let LNG_BASE  = parseFloat(localStorage.getItem('cfg_lng') ?? '-43.3498248374091');
    let RAIO_KM   = parseFloat(localStorage.getItem('cfg_raio') ?? '2'); // permitido

    // CSV com a base de motoristas (na RAIZ do repositório)
    const CSV_URL = 'drivers.csv';

    // ============================================================

    const $id = s => document.querySelector(s);
    const msgOk  = $id('#msg');
    const msgErr = $id('#err');
    const permBadge = $id('#permBadge');
    const raioBadge = $id('#raioBadge');

    raioBadge.textContent = RAIO_KM.toString();

    let baseMap = new Map(); // id -> nome

    // --- carregar CSV de motoristas ---
    async function carregarCSV(){
      try{
        const res = await fetch(CSV_URL, { cache:'no-store' });
        if(!res.ok) throw new Error('Erro ao carregar drivers.csv ('+res.status+')');
        const text = await res.text();

        // Espera: "Driver ID,Driver Name" (com vírgula)
        const linhas = text.split(/\r?\n/).filter(l=>l.trim().length);
        const head = linhas.shift().split(',').map(s=>s.trim().toLowerCase());
        const idxId = head.indexOf('driver id');
        const idxNm = head.indexOf('driver name');

        baseMap.clear();
        for(const l of linhas){
          const cols = l.split(',').map(s=>s.trim());
          if(idxId>=0 && idxNm>=0){
            const id = cols[idxId];
            const nm = cols[idxNm];
            if(id) baseMap.set(id, nm || '');
          }
        }
      }catch(e){
        showErr('Falha ao carregar base: '+ (e?.message||e));
      }
    }

    // --- util distância (Haversine) ---
    function distKm(aLat,aLng,bLat,bLng){
      const toRad = d=>d*Math.PI/180;
      const R=6371;
      const dLat = toRad(bLat-aLat), dLng = toRad(bLng-aLng);
      const s = Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(s));
    }

    // --- localização ---
    function pedirGeo(){
      navigator.geolocation.getCurrentPosition(
        ()=>atualizarPermissao('granted'),
        ()=>atualizarPermissao('denied'),
        { enableHighAccuracy:true, timeout:8000 }
      );
    }
    function atualizarPermissao(state){
      permBadge.textContent = 'Permissão: '+state;
    }

    // --- mensagens ---
    function showOk(t){ msgErr.style.display='none'; msgOk.style.display='block'; msgOk.textContent=t }
    function showErr(t){ msgOk.style.display='none'; msgErr.style.display='block'; msgErr.textContent=t }

    // --- check-in ---
    async function handleCheckin(){
      const id = $id('#driverId').value.trim();
      if(!id){ showErr('Informe seu Driver ID.'); return }

      if(baseMap.size===0){ showErr('Base não carregada. Verifique drivers.csv no repositório.'); return }

      const nome = baseMap.get(id);
      if(!nome){ showErr('ID não encontrado na base.'); return }

      // precisa de geolocalização
      if(!('geolocation' in navigator)){ showErr('Este navegador não suporta geolocalização.'); return }

      navigator.geolocation.getCurrentPosition(async pos=>{
        const { latitude, longitude, accuracy } = pos.coords;
        const d = distKm(latitude, longitude, LAT_BASE, LNG_BASE);
        if(d > RAIO_KM){
          showErr('Fora do raio permitido para check-in.');
          return;
        }

        // salvar local (no mesmo navegador)
        const logs = JSON.parse(localStorage.getItem('checkin_logs')||'[]');
        const dev  = localStorage.getItem('device_id') || (()=>{
          const v = crypto.randomUUID(); localStorage.setItem('device_id', v); return v;
        })();

        const reg = {
          ts: new Date().toISOString(),
          id, driver:nome, lat: latitude, lng: longitude, acc: Math.round(accuracy), dev
        };
        logs.push(reg);
        localStorage.setItem('checkin_logs', JSON.stringify(logs));

        showOk(`Check-in realizado com sucesso! Olá, ${nome}.`);
      }, err=>{
        showErr('É necessário permitir a localização para registrar o check-in.');
      }, { enableHighAccuracy:true, timeout:12000 });
    }

    // init
    (async function(){
      await carregarCSV();
      // tenta inferir estado de permissão (não é 100% garantido)
      if(navigator.permissions && navigator.permissions.query){
        try{
          const p = await navigator.permissions.query({ name:'geolocation' });
          atualizarPermissao(p.state);
          p.onchange = ()=>atualizarPermissao(p.state);
        }catch{}
      }
      $id('#btnGeo').onclick = pedirGeo;
      $id('#btnCheckin').onclick = handleCheckin;
    })();
  </script>
</body>
</html>
