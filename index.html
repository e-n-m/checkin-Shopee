<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check-in HUB • Motorista</title>
  <link rel="icon" href="favicon.ico" />
  <style>
    :root{
      --terracotta:#E55A36;
      --terracotta-dk:#cf4e2f;
      --bg:#f5f6f8;
      --card:#ffffff;
      --txt:#1b1d22;
      --muted:#6b7280;
      --ok:#128754;
      --warn:#b45309;
      --err:#b91c1c;
      --ring:rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--txt);
      background:var(--bg);
    }
    header{
      background:#0f172a;
      color:#fff;
      padding:14px 18px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    header .logo{
      width:24px;height:24px;display:inline-block;
      background:url('shopito.svg') center/cover no-repeat;
      border-radius:6px;
    }
    header .title{font-weight:600}
    header .sub{opacity:.8;font-size:12px;margin-left:6px}

    .wrap{
      max-width:980px;margin:28px auto;padding:0 16px;
    }
    .card{
      background:var(--card);
      border-radius:16px;
      box-shadow:0 24px 48px var(--ring);
      padding:28px;
    }
    h1{font-size:22px;margin:0 0 16px}
    .row{display:flex;gap:16px;align-items:center;margin:12px 0 18px}
    .row input{
      flex:1 1 auto;
      font:18px;
      padding:16px 18px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      outline:none;
    }
    .row input:focus{border-color:#cfd4dc;box-shadow:0 0 0 4px rgba(0,0,0,.06)}
    .btn{
      border:0;border-radius:12px;
      padding:16px 18px;font-weight:700;font-size:18px;
      cursor:pointer;transition:.15s transform ease;
      box-shadow:0 10px 20px rgba(229,90,54,.2);
      background:var(--terracotta);color:#fff;
    }
    .btn:hover{background:var(--terracotta-dk);transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-ghost{
      background:#fdece7;color:#5c2a20;border:1px solid #fad6ce;
      box-shadow:none;font-weight:700;
    }
    .note{
      background:#fff7ed;color:#7c3e07;border:1px solid #fed7aa;
      padding:14px 16px;border-radius:12px;
    }
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:#0b1220;color:#fff;font-size:12px;margin:10px 10px 0 0;opacity:.9}
    .ok{color:var(--ok);margin-top:10px;font-weight:700}
    .err{color:var(--err);margin-top:10px;font-weight:700}
    .muted{color:var(--muted)}
    .footer{margin-top:10px;font-size:12px;color:#667085}
  </style>
</head>
<body>
  <header>
    <span class="logo" aria-hidden="true"></span>
    <span class="title">Check-in HUB</span>
    <span class="sub">Motorista • Operação Shopee • Check-in com geolocalização</span>
  </header>

  <main class="wrap">
    <section class="card">
      <h1>Check-in</h1>
      <div class="row">
        <input id="driverId" inputmode="numeric" placeholder="Digite seu Driver ID" />
        <button id="btnCheck" class="btn">Registrar check-in</button>
      </div>

      <div class="row">
        <button id="btnLoc" class="btn btn-ghost">Habilitar localização</button>
        <span class="muted">Ative a localização e permita o acesso quando solicitado.</span>
      </div>

      <div class="note">Para registrar o check-in é necessário permitir a localização.</div>

      <div id="msg" class="err" style="display:none"></div>
      <div id="ok" class="ok" style="display:none"></div>

      <div>
        <span id="permBadge" class="chip">Permissão: —</span>
        <span id="raioBadge" class="chip">Raio: —</span>
      </div>

      <div class="footer muted">© Check-in HUB • dados locais no navegador • CSV: <code>driver(s).csv</code></div>
    </section>
  </main>

  <script>
    // ====== CONFIGURAÇÃO (edite se necessário) ==============================
    const LAT_BASE  = -22.798782412241856; // HUB lat
    const LNG_BASE  = -43.3498248374091;   // HUB lng
    const RAIO_KM   = 2;                    // raio permitido em km
    // =======================================================================

    // status UI
    const $ = sel => document.querySelector(sel);
    const setMsg = (txt) => { const n=$("#msg"); n.textContent=txt; n.style.display=txt?'block':'none'; };
    const setOk  = (txt) => { const n=$("#ok");  n.textContent=txt; n.style.display=txt?'block':'none'; };

    $("#raioBadge").textContent = `Raio: ${RAIO_KM} km`;

    // ======= CSV: tenta driver.csv, depois drivers.csv + cache-buster =======
    let baseMotoristas = [];
    function parseCSVflex(text){
      const linhas = text.replace(/\r/g,'').split('\n').map(l=>l.trim()).filter(Boolean);
      if(!linhas.length) return [];
      const header = linhas[0].split(/[;,]/).map(h=>h.trim().toLowerCase());
      const idxId   = header.findIndex(h=>/driver\s*id/i.test(h) || h==='id' || h==='driverid');
      const idxName = header.findIndex(h=>/driver\s*name/i.test(h) || h==='name' || h==='drivername');
      const out=[];
      for(let i=1;i<linhas.length;i++){
        const cols = linhas[i].split(/[;,]/).map(c=>c.trim());
        const id   = (idxId>=0?cols[idxId]:cols[0]) || '';
        const name = (idxName>=0?cols[idxName]:cols[1]) || '';
        if(!id) continue;
        out.push({id, name});
      }
      return out;
    }
    async function carregarCSV(){
      const candidatos = ['driver.csv','drivers.csv','./driver.csv','./drivers.csv'];
      let ultimo = null;
      for(const url of candidatos){
        try{
          const r = await fetch(`${url}?v=${Date.now()}`, {cache:'no-store'});
          if(!r.ok) throw new Error(`HTTP ${r.status}`);
          const txt = await r.text();
          const arr = parseCSVflex(txt);
          if(!arr.length) throw new Error('CSV vazio/ inválido');
          baseMotoristas = arr;
          setMsg('');
          return;
        }catch(e){ ultimo=e; }
      }
      setMsg(`Base não carregada. Verifique driver(s).csv no repositório. (${ultimo?.message||'erro'})`);
    }

    // ======= Geolocalização & permissões ===================================
    let permissao = 'prompt';
    async function atualizarPermissao(){
      try{
        if(navigator.permissions?.query){
          const st = await navigator.permissions.query({name:'geolocation'});
          permissao = st.state;
          $("#permBadge").textContent = `Permissão: ${permissao}`;
          st.onchange = ()=>{ permissao = st.state; $("#permBadge").textContent = `Permissão: ${permissao}`; };
        }else{
          $("#permBadge").textContent = 'Permissão: (indisponível)';
        }
      }catch(e){
        $("#permBadge").textContent = 'Permissão: (best-effort)';
      }
    }

    function getPosition(opts={enableHighAccuracy:true,timeout:12000}){
      return new Promise((resolve,reject)=>{
        navigator.geolocation.getCurrentPosition(resolve,reject,opts);
      });
    }

    function haversine(lat1,lon1,lat2,lon2){
      const toRad = d=>d*Math.PI/180, R=6371;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
    }

    function nomeDoDriver(id){
      const f = baseMotoristas.find(x=> String(x.id).trim()===String(id).trim());
      return f?.name || '';
    }

    function salvarLog(reg){
      const k='checkin_logs';
      const arr = JSON.parse(localStorage.getItem(k)||'[]');
      arr.push(reg);
      localStorage.setItem(k, JSON.stringify(arr));
    }

    // ======= Ações UI =======================================================
    $("#btnLoc").onclick = async ()=>{
      setOk(''); setMsg('');
      try{
        await getPosition();
        setOk('Localização habilitada com sucesso.');
      }catch(e){
        setMsg('É necessário permitir a localização para registrar o check-in.');
      }
    };

    $("#btnCheck").onclick = async ()=>{
      setOk(''); setMsg('');
      const id = $("#driverId").value.trim();
      if(!id){ setMsg('Informe seu Driver ID.'); return; }

      if(!baseMotoristas.length){
        setMsg('Base não carregada. Verifique driver(s).csv no repositório.');
        return;
      }

      const nome = nomeDoDriver(id);
      if(!nome){
        setMsg('ID não encontrado na base.');
        return;
      }

      try{
        const pos = await getPosition();
        const {latitude:lat, longitude:lng, accuracy:acc} = pos.coords;
        const dist = haversine(lat,lng, LAT_BASE,LNG_BASE);
        if(dist>RAIO_KM){
          setMsg('Fora do raio permitido para check-in.');
          return;
        }
        const reg = { ts:new Date().toISOString(), id, driver:nome, lat, lng, acc };
        salvarLog(reg);
        setOk(`Check-in realizado com sucesso! Olá, ${nome}.`);
      }catch(e){
        setMsg('É necessário permitir a localização para registrar o check-in.');
      }
    };

    // ======= init ===========================================================
    (async function init(){
      await carregarCSV();
      await atualizarPermissao();
    })();
  </script>
</body>
</html>
