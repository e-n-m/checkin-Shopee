<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üìç Check-in HUB (Motorista)</title>

  <!-- Favicon embutido (ok em qualquer host) -->
  <link rel="icon" href="data:image/x-icon;base64,AAABAAEAICACAAEAAQAwAQAAFgAAACgAAAAgAAAAQAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A" />

  <style>
    :root{
      --terracota:#EE5A36;       /* bot√£o e destaques */
      --terracota-dk:#cf4d2f;    /* hover do bot√£o */
      --bg:#f5f6f8;
      --card:#ffffff;
      --txt:#1b1d22;
      --muted:#666;
      --ok:#0a7c2f;
      --err:#b00020;
      --badge:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{
      background:#0b1324;color:#fff;padding:10px 14px;display:flex;align-items:center;gap:10px;
      position:sticky;top:0;z-index:10
    }
    header .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    header img{height:24px;width:auto;border-radius:6px}
    header .pill{margin-left:auto;background:rgba(255,255,255,.08);padding:6px 10px;border-radius:999px;font-size:12px}
    main{max-width:920px;margin:28px auto;padding:0 14px}
    .card{background:var(--card);border-radius:16px;padding:24px 22px;box-shadow:0 12px 28px rgba(0,0,0,.08)}
    h2{margin:0 0 14px}
    .row{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    input[type="text"]{
      flex:1;min-width:220px;padding:14px 16px;border:1px solid #e6e8ef;border-radius:12px;font-size:18px;outline:none
    }
    button.btn{
      padding:14px 20px;border:0;border-radius:12px;cursor:pointer;font-weight:800;font-size:18px
    }
    .btn-primary{background:var(--terracota);color:#fff}
    .btn-primary:hover{background:var(--terracota-dk)}
    .btn-ghost{background:#ffe9e1;color:#5c2a1e}
    .note{margin-top:10px;padding:12px 14px;background:#fff4e5;border:1px solid #ffd29b;border-radius:12px;color:#7a4a00}
    .status-ok{color:var(--ok);font-weight:700;margin-top:10px}
    .status-err{color:var(--err);font-weight:700;margin-top:10px}
    .meta{font-size:12px;color:#aab;display:flex;gap:8px;margin-left:10px}
    .top-badges{margin-left:auto;display:flex;gap:8px}
    .badge{background:var(--badge);color:#fff;padding:4px 10px;border-radius:999px;font-size:12px}
    footer{color:#8b93a6;font-size:12px;text-align:center;margin:20px 0}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <!-- Mascote na RAIZ -->
      <img src="./shopito.svg" alt="Shopito" />
      <div>
        <div>üìç <strong>Check-in HUB</strong> <span style="font-weight:600;color:#8ab">(Motorista)</span></div>
        <div class="meta">Opera√ß√£o Shopee ‚Ä¢ Check-in com geolocaliza√ß√£o</div>
      </div>
    </div>
    <div class="top-badges">
      <div class="badge" id="permBadge">Permiss√£o: -</div>
      <div class="badge">Raio: <span id="raioInfo">-</span></div>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>Check-in</h2>
      <div class="row">
        <input id="idInput" type="text" inputmode="numeric" placeholder="Digite seu Driver ID" />
        <button id="goBtn" class="btn btn-primary">Registrar check-in</button>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="enableBtn" class="btn btn-ghost">Habilitar localiza√ß√£o</button>
        <div id="gpsTips" class="meta"></div>
      </div>

      <div class="note" id="hint">Para registrar o check-in √© necess√°rio permitir a localiza√ß√£o.</div>
      <div id="out" class=""></div>
    </section>
  </main>

  <footer>¬© Check-in HUB ‚Ä¢ dados locais no navegador ‚Ä¢ CSV: <code>drivers.csv</code></footer>

<script>
/* =================== CONFIGURA√á√ÉO =================== */
// HUB (geofence)
const LAT_BASE   = -22.798782412241856;
const LNG_BASE   = -43.3489248374091;
const RAIO_KM    = 2; // permitido

// CSV local (no reposit√≥rio)
const CSV_URL    = "https://raw.githubusercontent.com/e-n-m/checkin-Shopee/main/driver.csv";
// Antifraude: v√≠nculo de aparelho
const DEVICE_KEY  = 'hub_device_id';
const DEVINFO_KEY = 'hub_device_info';

/* =================== HELPERS =================== */
function normId(v){
  if (v == null) return '';
  return String(v).trim().replace(/\.0$/, '').replace(/\D+/g,'');
}
function deviceId(){
  let id = localStorage.getItem(DEVICE_KEY);
  if (!id){
    const a = crypto.getRandomValues(new Uint8Array(16));
    a[6] = (a[6] & 0x0f) | 0x40; // v4
    a[8] = (a[8] & 0x3f) | 0x80;
    id = Array.from(a,(v,i)=>(i===4||i===6||i===8||i===10?'-':'')+v.toString(16).padStart(2,'0')).join('');
    localStorage.setItem(DEVICE_KEY, id);
  }
  return id;
}
function collectDevInfo(){
  const info = {
    ua:navigator.userAgent||'',
    platform:navigator.platform||'',
    mem:navigator.deviceMemory||'',
    cores:navigator.hardwareConcurrency||'',
    lang:navigator.language||'',
    tz:(Intl.DateTimeFormat().resolvedOptions().timeZone||''),
    off:new Date().getTimezoneOffset(),
    scr: (window.screen? `${screen.width}x${screen.height}@${window.devicePixelRatio||1}` : ''),
    vendor: navigator.vendor||''
  };
  localStorage.setItem(DEVINFO_KEY, JSON.stringify(info));
  return info;
}
function distKm(lat1, lon1, lat2, lon2){
  const R=6371, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function setStatus(msg, ok=false){
  const el = document.getElementById('out');
  el.className = ok ? 'status-ok' : 'status-err';
  el.textContent = msg;
}
function setPermBadge(state){
  document.getElementById('permBadge').textContent = 'Permiss√£o: ' + state;
}

/* ============ Carregar CSV de motoristas (sem libs) ============ */
async function loadDrivers(){
  const res = await fetch(CSV_URL, {cache:'no-store'});
  if (!res.ok) throw new Error('Erro ao carregar drivers.csv ('+res.status+')');
  const text = await res.text();

  // parser simples: detecta delimitador, quebra linhas
  const delim = text.indexOf(';')>-1 && text.indexOf(',')===-1 ? ';' : ',';
  const lines = text.split(/\r?\n/).filter(l=>l.trim()!=='');
  if (!lines.length) return [];
  const header = lines[0].split(delim).map(s=>s.trim());
  const rows   = lines.slice(1).map(l=>l.split(delim));

  const COL_ID_KEYS   = ['Driver ID','ID DRIVER','ID Driver','driver_id'];
  const COL_NOME_KEYS = ['Driver Name','DRIVER','Driver','NOME'];

  const up = s => (s||'').toString().trim().toUpperCase();
  const H  = header.map(up);

  function colIdx(keys){
    for (const k of keys){
      const i = H.indexOf(k.toUpperCase());
      if (i!==-1) return i;
    }
    return -1;
  }
  const cId   = colIdx(COL_ID_KEYS);
  const cNome = colIdx(COL_NOME_KEYS);
  if (cId===-1) throw new Error('Coluna de ID n√£o encontrada no CSV.');
  // nome √© opcional

  const arr = rows.map(r => ({
    id:   normId(r[cId]),
    nome: (cNome>-1 ? (r[cNome]||'').trim() : '')
  })).filter(o => o.id);

  // index por id p/ lookup r√°pido
  const map = new Map(arr.map(o => [o.id, o]));
  return {list:arr, map};
}

/* ==================== Geolocaliza√ß√£o ==================== */
async function getPermissionState(){
  if (!('permissions' in navigator) || !navigator.permissions.query) return 'desconhecida';
  try{
    const st = await navigator.permissions.query({name:'geolocation'});
    return st.state; // 'granted' | 'prompt' | 'denied'
  }catch(_){ return 'desconhecida'; }
}
async function getLocationOnce(){
  return new Promise((resolve,reject)=>{
    const opts={enableHighAccuracy:true,timeout:15000,maximumAge:0};
    navigator.geolocation.getCurrentPosition(
      pos => resolve({
        lat: pos.coords?.latitude,
        lng: pos.coords?.longitude,
        acc: pos.coords?.accuracy
      }),
      err => reject(err),
      opts
    );
  });
}

/* ==================== L√≥gica principal ==================== */
let drivers = null;

async function init(){
  // UI iniciais
  document.getElementById('raioInfo').textContent = RAIO_KM + ' km';
  collectDevInfo();
  deviceId();

  // estado de permiss√£o
  setPermBadge(await getPermissionState());

  // dicas
  const tips = document.getElementById('gpsTips');
  tips.textContent = 'Ative a localiza√ß√£o e permita o acesso quando solicitado.';

  // carregar CSV
  try{
    drivers = await loadDrivers();
    console.log('Registros carregados:', drivers.list.length);
  }catch(err){
    setStatus('Falha ao carregar base: ' + (err?.message||err), false);
  }
}

async function doCheckin(){
  const raw = document.getElementById('idInput').value;
  const id  = normId(raw);
  if (!id){ setStatus('Informe seu ID.', false); return; }
  if (!drivers || !drivers.map.size){
    setStatus('Base n√£o carregada. Verifique drivers.csv no reposit√≥rio.', false); return;
  }
  const row = drivers.map.get(id);
  if (!row){
    setStatus('ID n√£o encontrado na base.', false); return;
  }

  // exigir GPS
  if (!('geolocation' in navigator)){
    setStatus('Seu navegador n√£o suporta geolocaliza√ß√£o.', false); return;
  }

  try{
    const loc = await getLocationOnce();
    setPermBadge(await getPermissionState());

    if (loc?.lat==null || loc?.lng==null){
      setStatus('Localiza√ß√£o n√£o informada. Tente novamente.', false); return;
    }

    const d = distKm(LAT_BASE, LNG_BASE, Number(loc.lat), Number(loc.lng));
    if (isFinite(d) && d>RAIO_KM){
      setStatus('Fora do raio permitido para check-in.', false); return;
    }

    // Registro local (log no navegador) ‚Äî voc√™ pode exportar no admin
    const logs = JSON.parse(localStorage.getItem('hub_logs')||'[]');
    logs.push({
      ts: new Date().toISOString(),
      id, driver: row.nome||'',
      lat: loc.lat, lng: loc.lng, acc: loc.acc ?? '',
      dev: localStorage.getItem(DEVICE_KEY)||'',
    });
    localStorage.setItem('hub_logs', JSON.stringify(logs));

    setStatus('‚úÖ Check-in realizado com sucesso! ' + (row.nome? `Ol√°, ${row.nome}.` : ''), true);
  }catch(err){
    let msg = 'Falha ao obter sua localiza√ß√£o.';
    if (err?.code===1) msg = 'Permiss√£o negada. Ative a localiza√ß√£o para este site.';
    if (err?.code===2) msg = 'N√£o foi poss√≠vel obter a localiza√ß√£o. Tente novamente.';
    if (err?.code===3) msg = 'Tempo esgotado ao obter localiza√ß√£o.';
    setStatus(msg, false);
  }
}

document.getElementById('goBtn').addEventListener('click', doCheckin);
document.getElementById('idInput').addEventListener('keydown', e => { if (e.key==='Enter') doCheckin(); });

document.getElementById('enableBtn').addEventListener('click', async ()=>{
  try{ await getLocationOnce(); }catch(_){}
  setPermBadge(await getPermissionState());
});

init();
</script>
</body>
</html>
